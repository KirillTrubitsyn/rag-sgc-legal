# Техническая архитектура RAG-SGC-Legal

## Обзор системы

RAG-SGC-Legal — юридический ассистент для поиска и анализа нормативных документов СГК. Система использует архитектуру RAG (Retrieval-Augmented Generation) для предоставления ответов на основе загруженных документов.

```
┌─────────────────────────────────────────────────────────────┐
│                    FRONTEND (Browser)                       │
│           ChatInterface.tsx + Vercel AI SDK                 │
└────────────────────────┬────────────────────────────────────┘
                         │ HTTP POST /api/chat
                         ▼
┌─────────────────────────────────────────────────────────────┐
│              BACKEND (Next.js Edge Runtime)                 │
│         route.ts → Search → LLM → Stream Transform          │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                    xAI API Services                         │
│         Documents Search + Grok-3-Fast Model                │
└─────────────────────────────────────────────────────────────┘
```

---

## Технологический стек

### Frontend
| Технология | Версия | Назначение |
|------------|--------|------------|
| React | 19.0.0 | UI-библиотека |
| Next.js | 15.1.4 | Фреймворк (App Router) |
| TypeScript | 5.7.2 | Типизация |
| Tailwind CSS | 3.4.17 | Стилизация |
| Vercel AI SDK | 4.0.0 | Управление чатом |
| react-markdown | 10.1.0 | Рендеринг Markdown |
| lucide-react | 0.469.0 | Иконки |
| next-pwa | 5.6.0 | PWA поддержка |

### Backend
| Технология | Версия | Назначение |
|------------|--------|------------|
| Next.js Edge Runtime | 15.1.4 | Серверная логика |
| @ai-sdk/xai | 3.0.23 | Интеграция с xAI |
| sharp | 0.34.5 | Обработка изображений |

---

## Структура проекта

```
rag-sgc-legal/
├── app/
│   ├── api/
│   │   └── chat/
│   │       └── route.ts          # API endpoint чата
│   ├── components/
│   │   └── chat/
│   │       └── ChatInterface.tsx # Главный UI компонент
│   ├── globals.css               # Глобальные стили
│   ├── layout.tsx                # Root layout
│   └── page.tsx                  # Главная страница
├── lib/
│   ├── grok-client.ts            # RAG конфигурация и промпты
│   └── utils.ts                  # Утилиты
├── public/
│   ├── manifest.json             # PWA манифест
│   └── icon-*.png                # Иконки приложения
├── .env.example                  # Пример переменных окружения
├── next.config.js                # Next.js + PWA конфигурация
├── tailwind.config.js            # Tailwind конфигурация
└── tsconfig.json                 # TypeScript конфигурация
```

---

## Компоненты системы

### 1. ChatInterface (Frontend)

**Файл:** `app/components/chat/ChatInterface.tsx`

Главный React-компонент, управляющий UI чата.

**Состояние (через useChat hook):**
```typescript
const {
  messages,         // История сообщений
  input,            // Текущий ввод
  handleInputChange,// Обработчик ввода
  handleSubmit,     // Отправка сообщения
  isLoading,        // Индикатор загрузки
  error             // Ошибки
} = useChat({ api: '/api/chat' });
```

**Части интерфейса:**
- Header с логотипом СГК
- Область сообщений с прокруткой
- Карточки найденных документов (toolInvocations)
- Поле ввода с кнопкой отправки
- Анимация загрузки

### 2. Chat API (Backend)

**Файл:** `app/api/chat/route.ts`

Edge-функция обработки запросов чата.

**Конфигурация:**
```typescript
export const config = {
  runtime: 'edge',
  maxDuration: 60,           // Максимум 60 секунд
  api: { bodyParser: { sizeLimit: '10mb' } }
};
```

**Логика обработки:**
1. Парсинг входящих сообщений
2. Извлечение последнего запроса пользователя
3. Поиск релевантных документов через xAI API
4. Формирование контекста для LLM
5. Вызов Grok-3-Fast с потоковым ответом
6. Трансформация SSE → формат AI SDK

### 3. RAG Client

**Файл:** `lib/grok-client.ts`

Конфигурация поиска и системные промпты.

**Интерфейсы:**
```typescript
interface SearchOptions {
  collectionIds?: string[];
  topK?: number;
  retrievalMode?: 'hybrid' | 'semantic' | 'keyword';
}

interface SearchResult {
  content: string;
  source: string;
  score?: number;
  page?: number;
}
```

---

## Поток данных RAG

### Последовательность обработки запроса

```
User Input: "Порядок подготовки претензий"
                    │
                    ▼
┌───────────────────────────────────────────────┐
│ 1. ChatInterface отправляет POST /api/chat    │
│    Body: { messages: [...] }                  │
└───────────────────────────────────────────────┘
                    │
                    ▼
┌───────────────────────────────────────────────┐
│ 2. route.ts извлекает последнее сообщение     │
│    query = "Порядок подготовки претензий"     │
└───────────────────────────────────────────────┘
                    │
                    ▼
┌───────────────────────────────────────────────┐
│ 3. searchCollection() → xAI Documents API     │
│    POST https://api.x.ai/v1/documents/search  │
│    retrieval_mode: "hybrid"                   │
│    max_num_results: 20                        │
└───────────────────────────────────────────────┘
                    │
                    ▼
┌───────────────────────────────────────────────┐
│ 4. Форматирование результатов поиска          │
│    [1] Документ (релевантность: 0.95)         │
│    Содержимое...                              │
└───────────────────────────────────────────────┘
                    │
                    ▼
┌───────────────────────────────────────────────┐
│ 5. Формирование System Prompt                 │
│    legalSystemPrompt + НАЙДЕННЫЕ ДОКУМЕНТЫ    │
└───────────────────────────────────────────────┘
                    │
                    ▼
┌───────────────────────────────────────────────┐
│ 6. xAI Chat Completions (streaming)           │
│    POST https://api.x.ai/v1/chat/completions  │
│    model: "grok-3-fast"                       │
│    stream: true                               │
└───────────────────────────────────────────────┘
                    │
                    ▼
┌───────────────────────────────────────────────┐
│ 7. Stream Transform: SSE → AI SDK format      │
│    "data: {...}" → "0: \"text\""              │
└───────────────────────────────────────────────┘
                    │
                    ▼
┌───────────────────────────────────────────────┐
│ 8. ChatInterface обновляет UI в реальном      │
│    времени через useChat hook                 │
└───────────────────────────────────────────────┘
```

---

## API интеграции

### xAI Documents Search

**Endpoint:** `POST https://api.x.ai/v1/documents/search`

**Request:**
```json
{
  "query": "поисковый запрос",
  "source": {
    "collection_ids": ["<COLLECTION_ID>"]
  },
  "retrieval_mode": {
    "type": "hybrid"
  },
  "max_num_results": 20,
  "top_k": 20
}
```

**Response:**
```json
{
  "matches": [
    {
      "chunk_content": "текст из документа",
      "fields": {
        "file_name": "document.pdf",
        "name": "Название",
        "title": "Заголовок"
      },
      "score": 0.95
    }
  ]
}
```

### xAI Chat Completions

**Endpoint:** `POST https://api.x.ai/v1/chat/completions`

**Request:**
```json
{
  "model": "grok-3-fast",
  "messages": [
    { "role": "system", "content": "промпт с контекстом" },
    { "role": "user", "content": "вопрос" }
  ],
  "stream": true
}
```

**Response (SSE):**
```
data: {"choices":[{"delta":{"content":"токен"}}]}
data: {"choices":[{"delta":{"content":" текста"}}]}
data: [DONE]
```

---

## Системный промпт

Ассистент работает по следующим правилам:

1. Отвечает **ТОЛЬКО** на основе найденных документов
2. **НЕ** использует внешние знания
3. Цитирует конкретные пункты и разделы
4. Указывает источники (название документа, раздел)
5. При отсутствии информации — сообщает об этом

**Формат ответов:**
```markdown
**Цитаты из документов:**

1. **Раздел:** *«Цитата»* (Источник: документ, раздел)
2. **Раздел:** *«Цитата»* (Источник: документ, раздел)
```

---

## Переменные окружения

| Переменная | Обязательная | Описание |
|------------|--------------|----------|
| `XAI_API_KEY` | Да | API ключ xAI (console.x.ai) |
| `COLLECTION_ID` | Да | ID коллекции документов |
| `XAI_BASE_URL` | Нет | Base URL API (по умолчанию https://api.x.ai/v1) |

**Пример `.env.local`:**
```env
XAI_API_KEY=xai-xxxxxxxxxxxxxxxxxxxx
COLLECTION_ID=col-xxxxxxxxxxxxxxxxxxxx
```

---

## Производительность

| Параметр | Значение |
|----------|----------|
| Runtime | Edge (Vercel Edge Runtime) |
| Максимальная длительность запроса | 60 секунд |
| Максимальный размер body | 10 MB |
| Количество результатов поиска | до 20 |
| Streaming | SSE (Server-Sent Events) |

---

## PWA конфигурация

**Файл:** `public/manifest.json`

```json
{
  "name": "Юридическая служба СГК",
  "short_name": "ЮС СГК",
  "start_url": "/",
  "display": "standalone",
  "orientation": "portrait-primary",
  "background_color": "#0a1520",
  "theme_color": "#1e3a5f"
}
```

**Особенности:**
- Standalone режим (без браузерного UI)
- Портретная ориентация
- Брендовые цвета СГК
- Иконки 192x192 и 512x512

---

## Брендовые цвета

```css
/* SGC Palette */
--sgc-blue-900: #0a1520   /* Темный фон */
--sgc-blue-700: #0f2035   /* Карточки */
--sgc-blue-500: #1e3a5f   /* Акценты */
--sgc-orange-500: #f7941d /* Основной оранжевый */
--sgc-orange-600: #e8850a /* Темный оранжевый */
```

---

## Обработка ошибок

| Ситуация | Поведение |
|----------|-----------|
| Ошибка поиска документов | Продолжение без контекста |
| Ошибка API | JSON с полем `error` |
| Невалидный JSON в stream | Пропуск, продолжение потока |
| Отсутствие API ключа | HTTP 500 с описанием |

---

## Запуск и развертывание

### Локальная разработка

```bash
# Установка зависимостей
npm install

# Копирование переменных окружения
cp .env.example .env.local
# Заполнить XAI_API_KEY и COLLECTION_ID

# Запуск dev-сервера
npm run dev
```

### Production сборка

```bash
# Сборка
npm run build

# Запуск
npm start
```

### Деплой на Vercel

1. Подключить репозиторий к Vercel
2. Настроить Environment Variables:
   - `XAI_API_KEY`
   - `COLLECTION_ID`
3. Deploy

---

## Диаграмма компонентов

```
┌─────────────────────────────────────────────────────────────┐
│                         Browser                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │               ChatInterface.tsx                      │   │
│  │  ┌───────────┐  ┌──────────────┐  ┌────────────┐   │   │
│  │  │  Header   │  │  Messages    │  │   Input    │   │   │
│  │  │  (Logo)   │  │  Area        │  │   Area     │   │   │
│  │  └───────────┘  └──────────────┘  └────────────┘   │   │
│  │                        │                            │   │
│  │                 ┌──────┴──────┐                     │   │
│  │                 │  useChat()  │                     │   │
│  │                 │  AI SDK     │                     │   │
│  │                 └──────┬──────┘                     │   │
│  └────────────────────────┼────────────────────────────┘   │
│                           │                                 │
└───────────────────────────┼─────────────────────────────────┘
                            │ POST /api/chat
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    Next.js Edge Runtime                     │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                   route.ts                           │   │
│  │  ┌─────────────┐  ┌────────────┐  ┌─────────────┐  │   │
│  │  │ Parse       │→ │ Search     │→ │ Build       │  │   │
│  │  │ Messages    │  │ Documents  │  │ Context     │  │   │
│  │  └─────────────┘  └────────────┘  └─────────────┘  │   │
│  │                                          │          │   │
│  │  ┌─────────────┐  ┌────────────┐         │          │   │
│  │  │ Transform   │← │ Call LLM   │←────────┘          │   │
│  │  │ Stream      │  │ Streaming  │                    │   │
│  │  └─────────────┘  └────────────┘                    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │               grok-client.ts                         │   │
│  │  ┌─────────────────┐  ┌─────────────────────────┐  │   │
│  │  │ legalSystemPrompt│  │ searchCollection()      │  │   │
│  │  │ (Rules & Format) │  │ (Hybrid Search)         │  │   │
│  │  └─────────────────┘  └─────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                       xAI API                               │
├─────────────────────────────────────────────────────────────┤
│  ┌────────────────────────┐  ┌────────────────────────┐    │
│  │  Documents Search API  │  │  Chat Completions API  │    │
│  │  /v1/documents/search  │  │  /v1/chat/completions  │    │
│  │  - Hybrid retrieval    │  │  - grok-3-fast model   │    │
│  │  - Top-K results       │  │  - Streaming SSE       │    │
│  └────────────────────────┘  └────────────────────────┘    │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              Document Collection                     │   │
│  │  - PDF документы СГК                                │   │
│  │  - Векторные индексы                                │   │
│  │  - Метаданные (название, раздел)                    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## Контакты и поддержка

Для вопросов по архитектуре обращайтесь в ИТ-отдел СГК.
