/**
 * Конфигурация коллекций документов
 *
 * Для добавления новой коллекции:
 * 1. Добавьте переменную окружения в .env (например, CONTRACT_FORMS_COLLECTION_ID)
 * 2. Добавьте конфигурацию в COLLECTIONS_CONFIG ниже
 * 3. Создайте системный промпт в grok-client.ts (опционально, можно использовать базовый)
 */

export interface CollectionConfig {
  // Название переменной окружения с ID коллекции
  envKey: string;
  // Ключевые слова для определения запросов к этой коллекции
  keywords: string[];
  // Приоритет (чем выше, тем раньше проверяется). По умолчанию 0
  priority?: number;
  // Название коллекции для отображения пользователю
  displayName: string;
  // Описание коллекции
  description: string;
  // Использовать полный текст документа вместо чанков (для небольших документов)
  useFullContent?: boolean;
  // Примерный размер документа в токенах (для оценки загрузки)
  maxTokensPerDoc?: number;
}

/**
 * Конфигурация всех коллекций
 * Ключ - уникальный идентификатор коллекции (используется в коде)
 */
export const COLLECTIONS_CONFIG: Record<string, CollectionConfig> = {
  // Доверенности и полномочия сотрудников
  poa: {
    envKey: 'POA_COLLECTION_ID',
    displayName: 'Доверенности',
    description: 'Доверенности и полномочия сотрудников группы СГК',
    priority: 10, // Высокий приоритет - проверяется первым
    useFullContent: false, // Сканы PDF без OCR - используем чанки из поиска
    maxTokensPerDoc: 3000, // Примерный размер доверенности в токенах
    keywords: [
      // Основные термины
      'доверенност', 'полномочи', 'уполномоч', 'представител',
      'право подписи', 'право подписания', 'подписывать', 'подписать',
      'от имени', 'по доверенности', 'делегирован', 'передача полномочий',
      'кто может подписать', 'кто имеет право', 'кто уполномочен',
      'представлять интересы', 'действовать от имени',

      // Типы документов для подписания
      'подписание договор', 'подписать договор', 'заключить договор', 'заключать договор',
      'подписание акт', 'подписать акт', 'акт выполненных работ', 'акт приема',
      'подписание письм', 'подписать письм', 'письма в госорган', 'государственные органы',
      'подписание счет', 'подписать счет', 'счет-фактур',
      'подписание накладн', 'подписать накладн', 'товарная накладная',
      'подписание приказ', 'подписать приказ',
      'подписание соглашен', 'подписать соглашен', 'дополнительное соглашение',

      // Финансовые ограничения
      'на сумму', 'до суммы', 'лимит', 'ограничен', 'не более', 'не превышающ',
      'рублей', 'миллион', 'тысяч',

      // Организации группы СГК
      'от имени сгк', 'от имени кузбассэнерго', 'от имени енисейской', 'от имени тгк',
      'сгк', 'кузбассэнерго', 'енисейская', 'тгк-13', 'тгк 13',

      // Вопросы о возможности/праве
      'может ли', 'имеет ли право', 'есть ли у', 'вправе ли',
      'кто может', 'кто вправе', 'кто имеет',

      // ФИО из документов
      'мажирин', 'денисов', 'ким', 'пономарева', 'голофаст', 'шемчук', 'стромов',
    ],
  },

  // Формы и шаблоны договоров
  contractForms: {
    envKey: 'CONTRACT_FORMS_COLLECTION_ID',
    displayName: 'Формы договоров',
    description: 'Шаблоны и формы типовых договоров',
    priority: 5,
    useFullContent: true, // Шаблоны обычно небольшие - загружать целиком
    maxTokensPerDoc: 5000,
    keywords: [
      // Основные термины
      'форма договор', 'шаблон договор', 'бланк договор', 'типовой договор',
      'образец договор', 'форма контракт', 'шаблон контракт',
      'форма соглашен', 'шаблон соглашен',
      'форма акт', 'шаблон акт', 'бланк акт',
      'типовая форма', 'унифицированная форма',
      // Типы договоров из коллекции
      'договор оказания услуг', 'договор на оценк', 'договор медосмотр',
      'договор образовательн', 'договор аренд', 'договор поставк',
      'договор подряд', 'инженерные изыскан', 'поставка мазут', 'поставка гсм',
      // Вопросы о формах
      'какую форму', 'какой шаблон', 'как оформить договор',
      'стандартная форма', 'типовой образец',
    ],
  },

  // Уставы организаций группы СГК
  articlesOfAssociation: {
    envKey: 'ARTICLES_OF_ASSOCIATION_COLLECTION_ID',
    displayName: 'Уставы',
    description: 'Уставы организаций группы компаний СГК',
    priority: 5,
    useFullContent: false, // Уставы большие - использовать чанки
    maxTokensPerDoc: 10000,
    keywords: [
      // Основные термины
      'устав', 'уставн', 'учредительн', 'учредитель',
      'устав организации', 'устав компании', 'устав общества',
      'уставной капитал', 'уставный капитал', 'уставной фонд',
      // Содержание устава
      'органы управления', 'совет директоров', 'общее собрание',
      'единоличный исполнительный орган', 'генеральный директор',
      'компетенция органов', 'полномочия органов',
      'реорганизация', 'ликвидация', 'выплата дивиденд',
      // Организации группы СГК
      'устав сгк', 'устав кузбассэнерго', 'устав енисейской', 'устав тгк',
      'устав абаканской', 'устав дельта технолоджи', 'устав ново-кемеровской',
      // Вопросы об уставах
      'что говорит устав', 'по уставу', 'согласно устав', 'в уставе',
      'предусмотрено уставом', 'уставная деятельность',
    ],
  },

  // Общая коллекция (fallback) - всегда последняя по приоритету
  general: {
    envKey: 'COLLECTION_ID',
    displayName: 'Нормативные документы',
    description: 'Общая коллекция нормативных документов и стандартов СГК',
    priority: -1, // Самый низкий приоритет - используется как fallback
    useFullContent: false, // Большие документы - использовать чанки
    keywords: [], // Пустой массив = используется по умолчанию
  },
};

/**
 * Ключевые слова для определения запросов о ПОЛНОМ СПИСКЕ документов
 */
export const LIST_ALL_KEYWORDS = [
  // Прямые запросы на полный список
  'все доверенност', 'всех доверенност', 'всем доверенност',
  'все документ', 'всех документ', 'всем документ',
  'все форм', 'всех форм', 'все шаблон', 'всех шаблон',
  'полный список', 'полного списка', 'полном списке',
  'список всех', 'перечень всех', 'перечисли все', 'перечислить все',
  'покажи все', 'покажи всех', 'показать все', 'показать всех',
  'выведи все', 'выведи всех', 'вывести все', 'вывести всех',
  'какие доверенност', 'какие документ', 'какие форм', 'какие шаблон',
  'сколько доверенност', 'сколько документ', 'сколько форм',
  'общее количество', 'общий список',
  'таблица всех', 'таблицу всех', 'таблица со всеми', 'таблицу со всеми',
  'составь таблицу', 'составить таблицу',
  'все имеющиеся', 'всех имеющихся', 'все загруженные', 'всех загруженных',
  'база доверенност', 'базе доверенност', 'базу доверенност',
  'в базе', 'из базы',
];

/**
 * Получить отсортированный список коллекций по приоритету (от высокого к низкому)
 */
export function getSortedCollections(): Array<[string, CollectionConfig]> {
  return Object.entries(COLLECTIONS_CONFIG)
    .sort(([, a], [, b]) => (b.priority ?? 0) - (a.priority ?? 0));
}

/**
 * Определить коллекцию по тексту запроса
 * @param query - текст запроса пользователя
 * @returns ID коллекции или 'general' если не найдена специфичная
 */
export function detectCollection(query: string): string {
  const lowerQuery = query.toLowerCase();

  // Проверяем коллекции в порядке приоритета
  for (const [collectionId, config] of getSortedCollections()) {
    // Пропускаем general - он используется как fallback
    if (collectionId === 'general') continue;

    // Проверяем наличие ключевых слов
    const hasKeyword = config.keywords.some(keyword =>
      lowerQuery.includes(keyword.toLowerCase())
    );

    if (hasKeyword) {
      return collectionId;
    }
  }

  return 'general';
}

/**
 * Проверить, запрашивает ли пользователь полный список документов
 */
export function isListAllQuery(query: string): boolean {
  const lowerQuery = query.toLowerCase();
  return LIST_ALL_KEYWORDS.some(keyword => lowerQuery.includes(keyword));
}

/**
 * Получить ID коллекции из переменных окружения
 */
export function getCollectionId(collectionKey: string): string | undefined {
  const config = COLLECTIONS_CONFIG[collectionKey];
  if (!config) return undefined;

  return process.env[config.envKey];
}

/**
 * Получить конфигурацию коллекции
 */
export function getCollectionConfig(collectionKey: string): CollectionConfig | undefined {
  return COLLECTIONS_CONFIG[collectionKey];
}
