/**
 * Конфигурация коллекций документов
 *
 * Для добавления новой коллекции:
 * 1. Добавьте переменную окружения в .env (например, CONTRACT_FORMS_COLLECTION_ID)
 * 2. Добавьте конфигурацию в COLLECTIONS_CONFIG ниже
 * 3. Создайте системный промпт в grok-client.ts (опционально, можно использовать базовый)
 */

export interface CollectionConfig {
  // Название переменной окружения с ID коллекции
  envKey: string;
  // Ключевые слова для определения запросов к этой коллекции
  keywords: string[];
  // Приоритет (чем выше, тем раньше проверяется). По умолчанию 0
  priority?: number;
  // Название коллекции для отображения пользователю
  displayName: string;
  // Описание коллекции
  description: string;
  // Использовать полный текст документа вместо чанков (для небольших документов)
  useFullContent?: boolean;
  // Примерный размер документа в токенах (для оценки загрузки)
  maxTokensPerDoc?: number;
}

/**
 * Конфигурация всех коллекций
 * Ключ - уникальный идентификатор коллекции (используется в коде)
 */
export const COLLECTIONS_CONFIG: Record<string, CollectionConfig> = {
  // Доверенности и полномочия сотрудников
  poa: {
    envKey: 'POA_COLLECTION_ID',
    displayName: 'Доверенности',
    description: 'Доверенности и полномочия сотрудников группы СГК',
    priority: 10, // Высокий приоритет - проверяется первым
    useFullContent: false, // Сканы PDF без OCR - используем чанки из поиска
    maxTokensPerDoc: 3000, // Примерный размер доверенности в токенах
    keywords: [
      // Основные термины
      'доверенност', 'полномочи', 'уполномоч', 'представител',
      'право подписи', 'право подписания', 'подписывать', 'подписать',
      'от имени', 'по доверенности', 'делегирован', 'передача полномочий',
      'кто может подписать', 'кто имеет право', 'кто уполномочен',
      'представлять интересы', 'действовать от имени',

      // Типы документов для подписания
      'подписание договор', 'подписать договор', 'заключить договор', 'заключать договор',
      'подписание акт', 'подписать акт', 'акт выполненных работ', 'акт приема',
      'подписание письм', 'подписать письм', 'письма в госорган', 'государственные органы',
      'подписание счет', 'подписать счет', 'счет-фактур',
      'подписание накладн', 'подписать накладн', 'товарная накладная',
      'подписание приказ', 'подписать приказ',
      'подписание соглашен', 'подписать соглашен', 'дополнительное соглашение',

      // Финансовые ограничения
      'на сумму', 'до суммы', 'лимит', 'ограничен', 'не более', 'не превышающ',
      'рублей', 'миллион', 'тысяч',

      // Организации группы СГК - ТОЛЬКО В КОНТЕКСТЕ ДОВЕРЕННОСТЕЙ
      // Общие названия организаций убраны, т.к. они ловят запросы про уставы и договоры
      'от имени сгк', 'от имени кузбассэнерго', 'от имени енисейской', 'от имени тгк',
      'доверенность сгк', 'доверенность кузбассэнерго', 'доверенность енисейской',
      'доверенности сгк', 'доверенности кузбассэнерго', 'доверенности енисейской',

      // Вопросы о возможности/праве
      'может ли', 'имеет ли право', 'есть ли у', 'вправе ли',
      'кто может', 'кто вправе', 'кто имеет',

      // ФИО из документов
      'мажирин', 'денисов', 'ким', 'пономарева', 'голофаст', 'шемчук', 'стромов',
    ],
  },

  // Формы и шаблоны договоров
  contractForms: {
    envKey: 'CONTRACT_FORMS_COLLECTION_ID',
    displayName: 'Формы договоров',
    description: 'Шаблоны и формы типовых договоров',
    priority: 5,
    useFullContent: true, // Шаблоны обычно небольшие - загружать целиком
    maxTokensPerDoc: 5000,
    keywords: [
      // Основные термины (единственное и множественное число, падежи)
      'форма договор', 'формы договор', 'форм договор', 'формах договор',
      'шаблон договор', 'шаблоны договор', 'шаблонов договор',
      'бланк договор', 'бланки договор', 'типовой договор', 'типовые договор',
      'образец договор', 'образцы договор',
      'форма контракт', 'формы контракт', 'шаблон контракт', 'шаблоны контракт',
      'форма соглашен', 'формы соглашен', 'шаблон соглашен', 'шаблоны соглашен',
      'форма акт', 'формы акт', 'шаблон акт', 'шаблоны акт', 'бланк акт', 'бланки акт',
      'типовая форма', 'типовые формы', 'унифицированная форма', 'унифицированные формы',

      // Типы договоров из коллекции
      'договор оказания услуг', 'договор на оценк', 'договор медосмотр',
      'договор образовательн', 'договор аренд', 'договор поставк',
      'договор подряд', 'инженерные изыскан', 'поставка мазут', 'поставка гсм',

      // Вопросы о формах
      'какую форму', 'какой шаблон', 'какие формы', 'какие шаблоны',
      'как оформить договор', 'стандартная форма', 'типовой образец',

      // Содержание и условия договоров
      'условия поставк', 'условия оплат', 'условия договор', 'существенные условия',
      'обязанности сторон', 'обязательства сторон', 'права сторон',
      'ответственность сторон', 'ответственность по договор',
      'порядок расчет', 'порядок оплат', 'сроки оплат', 'сроки поставк',
      'штрафные санкц', 'неустойк', 'пени по договор',
      'гарантийные обязательств', 'гарантии по договор', 'гарантийный срок',
      'расторжение договор', 'порядок расторжен', 'прекращение договор',
      'приемка товар', 'приемка работ', 'порядок приемк',
      'качество товар', 'требования к качеств',
      'форс-мажор', 'обстоятельства непреодолим',
      'разрешение спор', 'арбитраж', 'претензионный порядок',
      'конфиденциальност', 'коммерческая тайн',

      // Вопросы о содержании
      'что предусматривает договор', 'что содержит договор', 'что включает договор',
      'какие пункты', 'какие разделы', 'какие статьи договор',
    ],
  },

  // Уставы организаций группы СГК
  articlesOfAssociation: {
    envKey: 'ARTICLES_OF_ASSOCIATION_COLLECTION_ID',
    displayName: 'Уставы',
    description: 'Уставы организаций группы компаний СГК',
    priority: 5,
    useFullContent: false, // Уставы большие - использовать чанки
    maxTokensPerDoc: 10000,
    keywords: [
      // Основные термины
      'устав', 'уставн', 'учредительн', 'учредитель',
      'устав организации', 'устав компании', 'устав общества',
      'уставной капитал', 'уставный капитал', 'уставной фонд',

      // Органы управления
      'органы управления', 'совет директоров', 'совета директоров',
      'общее собрание', 'общего собрания', 'собрание акционеров', 'собрание участников',
      'единоличный исполнительный орган', 'генеральный директор', 'генерального директора',
      'коллегиальный исполнительный орган', 'правление',
      'ревизионная комиссия', 'ревизор',

      // Компетенция органов
      'компетенция органов', 'полномочия органов', 'компетенция совета',
      'полномочия по уставу', 'полномочия генерального директора',
      'полномочия директора', 'полномочия совета директоров',
      'компетенция общего собрания', 'компетенция собрания',
      'исключительная компетенция', 'к компетенции относ',
      'что решает совет директоров', 'что решает общее собрание',
      'что относится к компетенции', 'вопросы компетенции',
      'в чьей компетенции', 'кто принимает решение', 'кто утверждает',

      // Одобрение сделок и действий
      'одобрение сделк', 'одобрение крупн', 'согласование сделк',
      'крупная сделка', 'крупные сделки', 'сделка с заинтересованност',
      'требует одобрения', 'не требует одобрения', 'без одобрения',
      'должен одобрить', 'должен согласовать', 'необходимо одобрение',
      'предварительное одобрение', 'последующее одобрение',

      // Одобрение документов и проектов
      'утверждение положени', 'одобрение положени', 'принятие положени',
      'внутренние документ', 'внутренних документ', 'локальные акт',
      'инвестиционный проект', 'инвестиционные проект', 'инвестпроект',
      'утверждение проект', 'одобрение проект', 'согласование проект',
      'бизнес-план', 'годовой отчет', 'годовой бюджет',

      // Принятие и изменение устава
      'дата принятия устава', 'когда принят устав', 'дата утверждения устава',
      'изменение устава', 'изменения в устав', 'внесение изменений',
      'порядок изменения устава', 'как изменить устав',
      'редакция устава', 'новая редакция', 'действующая редакция',
      'утверждение устава', 'принятие устава',

      // Голосование и кворум
      'кворум', 'голосование', 'большинство голосов', 'единогласно',
      'квалифицированное большинство', 'простое большинство',
      'три четверти голосов', '3/4 голосов', '2/3 голосов',

      // Реорганизация и ликвидация
      'реорганизация', 'ликвидация', 'выплата дивиденд',
      'распределение прибыл', 'чистая прибыль',

      // Организации группы СГК
      'устав сгк', 'устав кузбассэнерго', 'устав енисейской', 'устав тгк',
      'устав абаканской', 'устав дельта технолоджи', 'устав ново-кемеровской',

      // Вопросы об уставах
      'что говорит устав', 'по уставу', 'согласно устав', 'в уставе',
      'предусмотрено уставом', 'уставная деятельность',
      'написано в уставе', 'указано в уставе', 'закреплено в уставе',
    ],
  },

  // Стандарты и регламенты (Standards and Regulations)
  standardsAndRegulations: {
    envKey: 'STANDARDS_AND_REGULATIONS_COLLECTION_ID',
    displayName: 'Стандарты и регламенты',
    description: 'Нормативные документы, стандарты, положения и регламенты СГК',
    priority: 3,
    useFullContent: false, // Большие документы - использовать чанки
    keywords: [
      // Основные термины
      'стандарт', 'регламент', 'положени', 'инструкци', 'норматив',
      'правила', 'порядок', 'методик', 'процедур',
      // Типы документов
      'р-гк', 'ст-гк', 'и-гк', 'п-гк', // Коды документов СГК
      'кадастров', 'мероприят', 'хранени', 'договорн',
      // Вопросы о документах
      'какой порядок', 'как оформить', 'какие требования', 'что регламентирует',
    ],
  },
};

/**
 * Ключевые слова для определения запросов о ПОЛНОМ СПИСКЕ документов
 */
export const LIST_ALL_KEYWORDS = [
  // Прямые запросы на полный список
  'все доверенност', 'всех доверенност', 'всем доверенност',
  'все документ', 'всех документ', 'всем документ',
  'все форм', 'всех форм', 'все шаблон', 'всех шаблон',
  'все устав', 'всех устав', 'все регламент', 'всех регламент',
  'полный список', 'полного списка', 'полном списке',
  'список всех', 'перечень всех', 'перечисли все', 'перечислить все',
  'покажи все', 'покажи всех', 'показать все', 'показать всех',
  'выведи все', 'выведи всех', 'вывести все', 'вывести всех',
  'какие доверенност', 'какие документ', 'какие форм', 'какие шаблон',
  'какие устав', 'какие регламент', 'какие стандарт',
  'сколько доверенност', 'сколько документ', 'сколько форм', 'сколько устав',
  'общее количество', 'общий список',
  'таблица всех', 'таблицу всех', 'таблица со всеми', 'таблицу со всеми',
  'составь таблицу', 'составить таблицу',
  'все имеющиеся', 'всех имеющихся', 'все загруженные', 'всех загруженных',
  'база доверенност', 'базе доверенност', 'базу доверенност',
  'в базе', 'из базы', 'есть в базе', 'у тебя есть',
  // Вопросы "что есть"
  'что есть', 'что у тебя', 'что имеется', 'что загружено',
];

/**
 * Получить отсортированный список коллекций по приоритету (от высокого к низкому)
 */
export function getSortedCollections(): Array<[string, CollectionConfig]> {
  return Object.entries(COLLECTIONS_CONFIG)
    .sort(([, a], [, b]) => (b.priority ?? 0) - (a.priority ?? 0));
}

/**
 * Определить коллекцию по тексту запроса
 * @param query - текст запроса пользователя
 * @returns ID коллекции или null если не найдена подходящая
 */
export function detectCollection(query: string): string | null {
  const lowerQuery = query.toLowerCase();

  // Собираем все совпадения с информацией о длине ключевого слова
  const matches: Array<{
    collectionId: string;
    priority: number;
    keyword: string;
    keywordLength: number;
  }> = [];

  for (const [collectionId, config] of getSortedCollections()) {
    // Находим все совпадающие ключевые слова
    for (const keyword of config.keywords) {
      if (lowerQuery.includes(keyword.toLowerCase())) {
        matches.push({
          collectionId,
          priority: config.priority ?? 0,
          keyword,
          keywordLength: keyword.length,
        });
      }
    }
  }

  if (matches.length === 0) {
    // При отсутствии совпадений возвращаем null - требуется уточнение у пользователя
    return null;
  }

  // Сортируем: сначала по длине ключевого слова (длинные = более специфичные),
  // затем по приоритету коллекции
  matches.sort((a, b) => {
    // Более длинные ключевые слова имеют преимущество
    const lengthDiff = b.keywordLength - a.keywordLength;
    if (lengthDiff !== 0) return lengthDiff;
    // При равной длине - по приоритету коллекции
    return b.priority - a.priority;
  });

  return matches[0].collectionId;
}

/**
 * Получить список всех коллекций для уточняющего вопроса
 * @returns строка с перечислением коллекций и их описаний
 */
export function getAvailableCollectionsList(): string {
  const collections = getSortedCollections()
    .filter(([, config]) => config.keywords.length > 0) // Только коллекции с ключевыми словами
    .map(([key, config]) => `• **${config.displayName}** — ${config.description}`)
    .join('\n');

  return collections;
}

/**
 * Проверить, запрашивает ли пользователь полный список документов
 */
export function isListAllQuery(query: string): boolean {
  const lowerQuery = query.toLowerCase();
  return LIST_ALL_KEYWORDS.some(keyword => lowerQuery.includes(keyword));
}

/**
 * Получить ID коллекции из переменных окружения
 */
export function getCollectionId(collectionKey: string): string | undefined {
  const config = COLLECTIONS_CONFIG[collectionKey];
  if (!config) return undefined;

  return process.env[config.envKey];
}

/**
 * Получить конфигурацию коллекции
 */
export function getCollectionConfig(collectionKey: string): CollectionConfig | undefined {
  return COLLECTIONS_CONFIG[collectionKey];
}
